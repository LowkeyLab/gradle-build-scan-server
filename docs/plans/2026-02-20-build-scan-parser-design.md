# Build Scan Parser Design

## Purpose
To correctly parse the raw gzip-compressed payload generated by Gradle's `--scan` option, captured via the `echo-server`. 

## Problem
The payload consists of LEB128 varints and raw UTF-8 byte strings. The current `StreamDecoder` attempts to parse everything as LEB128 varints, causing it to fail and lose synchronization when encountering multi-byte UTF-8 sequences. Furthermore, tokens are heavily context-dependent. A varint could be an Event ID, an integer value, a string length, or a back-reference to a previously seen string.

## Architecture

We will implement a **Hybrid State Machine**.

### 1. The Stream Decoder (Low-level Primitives)
`StreamDecoder` (in `build-scan/lib/src/primitives.rs`) will manage byte boundaries and provide explicit, typed primitive parsing methods, rather than returning an `Iterator`.

- `read_raw_varint(&mut self) -> Result<u64>`: Extracts a single LEB128 integer.
- `read_bytes(&mut self, len: usize) -> Result<&[u8]>`: Consumes `len` bytes from the stream.
- `read_varint(&mut self) -> Result<Primitive>`: Wraps `read_raw_varint` in `Primitive::Varint`.
- `read_string(&mut self) -> Result<Primitive>`: 
  - Reads a varint.
  - If the lowest bit is `1`, returns `Primitive::StringRef(id)`.
  - If the lowest bit is `0`, reads `length` bytes of raw UTF-8 data, and returns `Primitive::String(s)`.
- `read_timestamp(&mut self) -> Result<Primitive>`: Reads a varint, decodes the milliseconds since epoch, and returns `Primitive::Timestamp`.

### 2. The Parser State Machine (High-level Context)
`PayloadBuilder` (in `build-scan/lib/src/parser.rs`) will act as the state machine.
- It will read an Event ID using `read_raw_varint()`.
- Based on the Event ID, it will invoke the correct sequence of `StreamDecoder` explicit methods to reconstruct the event context.
- For unknown events, the parser will fail gracefully (with a robust error or skip heuristics if feasible).

### 3. Integration 
- No changes required to `cli/src/main.rs`.
- `models.rs` will be expanded to support the parsed properties.
- `error.rs` will be updated with relevant context errors.

## Success Criteria
- The parser can ingest an uncompressed Gradle scan payload stream.
- It correctly parses all primitive tokens (avoiding the "Malformed LEB128" error).
- It distinguishes between string literals and string dictionary references.